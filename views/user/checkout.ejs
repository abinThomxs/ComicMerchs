<!DOCTYPE html>
<html lang="en">

<%- include('../partials/loginSignupHeader.ejs') %>

  <body>

    <%- include('../partials/userNavbar.ejs') %>
      <%- include('../partials/offcanvas.ejs') %>
      
        <section>
          <div class="container py-5">
            <form id="checkout">
              <div class="row d-flex justify-content-center align-items-center h-100">
                <div class="col-12">
                  <div class="card card-registration card-registration-2" style="border-radius: 15px">
                    <div class="card-body p-0">
                      <div class="row g-0 ">
                        <div class="col-lg-8">
                          <div class="p-5 border">
                            <div class="d-flex justify-content-between align-items-center mb-5 ">
                              <h1 class="fw-bold mb-0" style="color: rgb(3, 3, 58);">Order Details</h1>
                            </div>
                            <table id="tableForm" class="table">
                              <thead>
                                <tr>

                                  <th scope="col">Product</th>
                                  <th scope="col">Quatity</th>
                                  <th scope="col">Cost</th>
                                  <th scope="col">Price</th>
                                </tr>
                              </thead>
                              <tbody>
                                <% allData.forEach(element=> { %>
                                  <tr>
                                    <td>
                                      <%= element.productDetail.productName %>
                                    </td>
                                    <td>
                                      <%= element.productQuantity %>
                                    </td>
                                    <td>
                                      <label>Rs. <%= element.productDetail.cost %>
                                    </td>
                                    <td>
                                      Rs. <%= element.productPrice %>
                                    </td>
                                  </tr>
                                  <% }) %>
                              </tbody>
                            </table>
                            <p>Shipping charge: Rs.100.00</p>
                            <p>Tax: Rs.<%= Math.round(sum*.15) %>.00 </p>
                            <b>Total: Rs.<%= Math.round(sum*.15) + sum + 100 %> </b>

                            <div class="payment col-md-6 mt-3 d-flex justify-content-center ms-5 px-5">
                              <h5 class="text-black">Payment:</h5>
                              <div class="p-1 col-md-8   text-dark">
                                <input type="radio" name="pay" value="cod" class="me-1" required checked />
                                Cash On Delivery
                              </div>
                              <div class="p-1 col-md-8  text-dark">
                                <input type="radio" name="pay" value="online" class="me-1"
                                  style="background-color: rgb(3, 3, 58); " required />
                                Pay Online
                              </div>
                            </div>




                          </div>
                        </div>
                        <div class="col-lg-4 text-light border border-secondary"
                          style="background-color: rgb(3, 3, 58);">
                          <div class="p-5">

                            <div class="shipadrss col-md-12 mt-3">
                              <h5 class="text-light">Shipping Address:</h5>

                              <% address.forEach(data=> { %>
                                <div style="border: 1px solid"
                                  class="p-4 d-flex align-content-center align-items-center d9">
                                  <input type="radio" value="<%= data._id %>" name="address" required checked />
                                  <p class="ms-3">
                                    <b>
                                      <%= name %>
                                    </b><br />
                                    <%= data.address %> <br>
                                      <%= data.state %>,
                                        <%= data.city %> <br>
                                          <%= data.pincode %>
                                  </p>
                                </div>
                                <% }) %>

                                  <div class="mt-3 d-flex align-items-center d9">
                                    <a href="/user/addAddress" class="btn btn-light">+ Add New Address</a>
                                  </div>

                            </div>



                          </div>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>

                <div class="payment col-md-2 mt-3 p-1">
                  <button type="submit" class="btn btn-primary btn-lg w-100 mt-2">
                    Confirm Order
                  </button>
                  <a href="/user/cart" class="btn btn-primary btn-lg w-100 mt-2">
                    Go Back
                  </a>
                </div>
            </form>

          </div>

        </section>






        <%- include('../partials/footer.ejs') %>

          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

          <script src="/js/user/main.js"></script>

          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

          <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
          <script>
            $("#checkout").submit((e) => {
              alert('Click ok to Confirm')
              e.preventDefault();
              $.ajax({
                url: "/user/orderConfirmed",
                method: "post",
                data: $("#checkout").serialize(),
                success: (response) => {
                  console.log(response);
                  if (response[0].success) {
                    location.href = `/user/orderSuccess`;
                  } else {
                    razorPay(response[0].orders);
                    console.log(response[0].orders)
                  }
                },
              });
            });
            function razorPay(order) {
              var options = {
                key: "rzp_test_Qz0gX7o4vKhyTg", // Enter the Key ID generated from the Dashboard
                amount: order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                currency: "INR",
                name: "ComicMerchs",
                description: "Test Transaction",
                order_id: order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                handler: function (response) {
                  console.log(response);
                  verifyPayment(response, order);
                },
                prefill: {
                  name: "abin",
                  email: "abin@gmail.com",
                  contact: "8089000000",
                },
                notes: {
                  address: "Razorpay Corporate Office",
                },
                theme: {
                  color: "#3399cc",
                },
              };
              var rzp1 = new Razorpay(options);
              console.log('options are  jksdfskjdsdfjsl', options);
              rzp1.on("payment.failed", function (response) {
              });
              rzp1.open();
            }
            function verifyPayment(payment, order) {
              console.log('order is', order);
              $.ajax({
                url: "/user/verifyPayment",
                data: {
                  payment,
                  order,
                },
                method: "post",
                success: (response) => {

                  if (response.success) {
                    location.href = '/user/orderSuccess';

                    // location.href = '/user/orderSuccess';
                    console.log('payment success');
                  } else {
                    location.href = "/user/paymentFail";
                    console.log('payment failed');
                  }
                },
              });
            }
          </script>

  </body>

</html>